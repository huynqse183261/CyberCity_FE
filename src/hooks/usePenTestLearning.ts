import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { penTestLearningService } from '../services/penTestLearningService';
import type { SubmitAnswerRequest, SubmitQuizRequest } from '../models/PenTestLearningTypes';

// ============ COURSE HOOKS ============

export const useCourses = () => {
  return useQuery({
    queryKey: ['courses'],
    queryFn: () => penTestLearningService.getAllCourses(),
    staleTime: 5 * 60 * 1000, // 5 minutes
  });
};

export const useCourse = (courseId: string) => {
  return useQuery({
    queryKey: ['course', courseId],
    queryFn: () => penTestLearningService.getCourseById(courseId),
    enabled: !!courseId,
    staleTime: 2 * 60 * 1000, // 2 minutes
  });
};

export const useEnrollCourse = () => {
  const queryClient = useQueryClient();
  
  return useMutation({
    mutationFn: (courseId: string) => penTestLearningService.enrollCourse(courseId),
    onSuccess: (_, courseId) => {
      queryClient.invalidateQueries({ queryKey: ['course', courseId] });
      queryClient.invalidateQueries({ queryKey: ['courses'] });
      queryClient.invalidateQueries({ queryKey: ['student-progress'] });
    },
  });
};

// ============ MODULE HOOKS ============

export const useModules = (courseId: string) => {
  return useQuery({
    queryKey: ['modules', courseId],
    queryFn: () => penTestLearningService.getModulesByCourse(courseId),
    enabled: !!courseId,
    staleTime: 5 * 60 * 1000,
  });
};

export const useModule = (moduleId: string) => {
  return useQuery({
    queryKey: ['module', moduleId],
    queryFn: () => penTestLearningService.getModuleById(moduleId),
    enabled: !!moduleId,
    staleTime: 2 * 60 * 1000,
  });
};

// ============ LESSON HOOKS ============

export const useLesson = (lessonId: string) => {
  return useQuery({
    queryKey: ['lesson', lessonId],
    queryFn: () => penTestLearningService.getLessonById(lessonId),
    enabled: !!lessonId,
    staleTime: 2 * 60 * 1000,
  });
};

export const useLessonContent = (lessonId: string) => {
  return useQuery({
    queryKey: ['lesson-content', lessonId],
    queryFn: () => penTestLearningService.getLessonContent(lessonId),
    enabled: !!lessonId,
    staleTime: 1 * 60 * 1000, // 1 minute
  });
};

// ============ SUBTOPIC HOOKS ============

export const useSubmitAnswer = () => {
  const queryClient = useQueryClient();
  
  return useMutation({
    mutationFn: ({ subtopicId, data }: { subtopicId: string; data: SubmitAnswerRequest }) =>
      penTestLearningService.submitSubtopicAnswer(subtopicId, data),
    onSuccess: (_, variables) => {
      queryClient.invalidateQueries({ queryKey: ['lesson-content'] });
      queryClient.invalidateQueries({ queryKey: ['student-progress'] });
      queryClient.invalidateQueries({ queryKey: ['course-progress'] });
    },
  });
};

export const useCompleteSubtopic = () => {
  const queryClient = useQueryClient();
  
  return useMutation({
    mutationFn: (subtopicId: string) =>
      penTestLearningService.completeSubtopic(subtopicId),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['lesson-content'] });
      queryClient.invalidateQueries({ queryKey: ['student-progress'] });
      queryClient.invalidateQueries({ queryKey: ['course-progress'] });
    },
  });
};

// ============ QUIZ HOOKS ============

export const useQuiz = (quizId: string) => {
  return useQuery({
    queryKey: ['quiz', quizId],
    queryFn: () => penTestLearningService.getQuizById(quizId),
    enabled: !!quizId,
    staleTime: 2 * 60 * 1000,
  });
};

export const useSubmitQuiz = () => {
  const queryClient = useQueryClient();
  
  return useMutation({
    mutationFn: ({ quizId, data }: { quizId: string; data: SubmitQuizRequest }) =>
      penTestLearningService.submitQuiz(quizId, data),
    onSuccess: (_, variables) => {
      queryClient.invalidateQueries({ queryKey: ['quiz', variables.quizId] });
      queryClient.invalidateQueries({ queryKey: ['student-progress'] });
      queryClient.invalidateQueries({ queryKey: ['course-progress'] });
    },
  });
};

// ============ LAB HOOKS ============

export const useLabs = (moduleId: string) => {
  return useQuery({
    queryKey: ['labs', moduleId],
    queryFn: () => penTestLearningService.getLabsByModule(moduleId),
    enabled: !!moduleId,
    staleTime: 5 * 60 * 1000,
  });
};

export const useLab = (labId: string) => {
  return useQuery({
    queryKey: ['lab', labId],
    queryFn: () => penTestLearningService.getLabById(labId),
    enabled: !!labId,
    staleTime: 2 * 60 * 1000,
  });
};

export const useStartLab = () => {
  return useMutation({
    mutationFn: (labId: string) => penTestLearningService.startLab(labId),
  });
};

export const useCompleteLab = () => {
  const queryClient = useQueryClient();
  
  return useMutation({
    mutationFn: (labId: string) => penTestLearningService.completeLab(labId),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['student-progress'] });
      queryClient.invalidateQueries({ queryKey: ['course-progress'] });
      queryClient.invalidateQueries({ queryKey: ['labs'] });
    },
  });
};

// ============ PROGRESS HOOKS ============

export const useStudentProgress = () => {
  return useQuery({
    queryKey: ['student-progress'],
    queryFn: () => penTestLearningService.getStudentProgress(),
    staleTime: 1 * 60 * 1000, // 1 minute
  });
};

export const useCourseProgress = (courseId: string) => {
  return useQuery({
    queryKey: ['course-progress', courseId],
    queryFn: () => penTestLearningService.getCourseProgress(courseId),
    enabled: !!courseId,
    staleTime: 1 * 60 * 1000,
  });
};
