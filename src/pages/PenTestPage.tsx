import React, { useEffect, useMemo, useState } from 'react';
import LinuxLabNavigation from '../components/LinuxLabNavigation';
import UserDropdown from '../components/UserDropdown';
import { useAuth } from '../contexts/AuthContext';
import type { User } from '../models/LinuxLabTypes';
import '../styles/LinuxLabPage.css';

const PenTestPage: React.FC = () => {
  const [introProgress, setIntroProgress] = useState<number[]>([95, 88, 75, 65, 45, 30]);
  const headerProgress = 15;
  const { user: currentUser } = useAuth();
  
  // Transform AuthContext user to component user format
  const user: User = {
    name: currentUser?.fullName || 'User',
    username: currentUser?.username || currentUser?.email || 'Unknown User',
    avatar: currentUser?.fullName?.charAt(0).toUpperCase() || 'U'
  };

  const modules = useMemo(() => [
    {
      title: 'Module 1: Gi·ªõi Thi·ªáu Penetration Testing',
      topics: [
        'Kh√°i ni·ªám v√† m·ª•c ƒë√≠ch c·ªßa Pentest',
        'C√°c lo·∫°i h√¨nh Penetration Testing',
        'Quy tr√¨nh v√† ph∆∞∆°ng ph√°p lu·∫≠n',
        'ƒê·∫°o ƒë·ª©c v√† ph√°p l√Ω trong Pentest',
        'C√°c c√¥ng c·ª• c∆° b·∫£n',
        'Thi·∫øt l·∫≠p m√¥i tr∆∞·ªùng lab'
      ],
      progress: introProgress[0],
      rating: 5,
      commentPlaceholder: 'Chia s·∫ª c·∫£m nh·∫≠n c·ªßa b·∫°n v·ªÅ module n√†y...'
    },
    {
      title: 'Module 2: Information Gathering',
      topics: [
        'Passive Information Gathering',
        'Active Information Gathering',
        'OSINT v√† Social Engineering',
        'DNS Enumeration',
        'Port Scanning v·ªõi Nmap',
        'Service v√† Version Detection'
      ],
      progress: introProgress[1],
      rating: 5,
      commentPlaceholder: 'Thu th·∫≠p th√¥ng tin l√† b∆∞·ªõc ƒë·∫ßu ti√™n...'
    },
    {
      title: 'Module 3: Vulnerability Assessment',
      topics: [
        'Ph√¢n lo·∫°i l·ªó h·ªïng b·∫£o m·∫≠t',
        'S·ª≠ d·ª•ng Nessus v√† OpenVAS',
        'Web Application Scanning',
        'Network Vulnerability Scanning',
        'Ph√¢n t√≠ch k·∫øt qu·∫£ scan',
        'Prioritization v√† Risk Assessment'
      ],
      progress: introProgress[2],
      rating: 5,
      commentPlaceholder: 'ƒê√°nh gi√° l·ªó h·ªïng l√† k·ªπ nƒÉng quan tr·ªçng...'
    },
    {
      title: 'Module 4: Web Application Testing',
      topics: [
        'OWASP Top 10',
        'SQL Injection',
        'Cross-Site Scripting (XSS)',
        'Cross-Site Request Forgery (CSRF)',
        'Authentication v√† Session Management',
        'Burp Suite v√† OWASP ZAP'
      ],
      progress: introProgress[3],
      rating: 5,
      commentPlaceholder: 'Web app testing l√† k·ªπ nƒÉng c·∫ßn thi·∫øt...'
    },
    {
      title: 'Module 5: Network Penetration Testing',
      topics: [
        'Network Architecture Analysis',
        'Man-in-the-Middle Attacks',
        'Password Cracking',
        'Privilege Escalation',
        'Lateral Movement',
        'Maintaining Access'
      ],
      progress: introProgress[4],
      rating: 4,
      commentPlaceholder: 'Network pentest ƒë√≤i h·ªèi ki·∫øn th·ª©c s√¢u...'
    },
    {
      title: 'Module 6: Exploitation v√† Post-Exploitation',
      topics: [
        'Metasploit Framework',
        'Exploit Development c∆° b·∫£n',
        'Buffer Overflow',
        'Post-Exploitation v·ªõi Meterpreter',
        'Data Exfiltration',
        'Covering Tracks'
      ],
      progress: introProgress[5],
      rating: 5,
      commentPlaceholder: 'Exploitation l√† giai ƒëo·∫°n quan tr·ªçng nh·∫•t...'
    }
  ], [introProgress]);

  useEffect(() => {
    const handleScroll = () => {
      const sections = document.querySelectorAll('.module');
      let updated = [...introProgress];
      sections.forEach((section, idx) => {
        const rect = section.getBoundingClientRect();
        const isVisible = rect.top < window.innerHeight && rect.bottom > 0;
        if (isVisible) {
          updated[idx] = modules[idx]?.progress ?? updated[idx];
        }
      });
      setIntroProgress(updated);
    };
    window.addEventListener('scroll', handleScroll);
    handleScroll();
    return () => window.removeEventListener('scroll', handleScroll);
  }, [modules, introProgress]);

  return (
    <div className="linux-lab-page">
      <nav className="navigation">
        <div className="nav-container">
          <LinuxLabNavigation />
          <UserDropdown user={user} />
        </div>
      </nav>

      <div className="linux-card-header">
        <div className="linux-card-left">
          <h1 className="linux-card-title">Kh√≥a H·ªçc Penetration Testing</h1>
          <p className="linux-card-desc">Kh√≥a h·ªçc th·ª±c h√†nh Penetration Testing t·ª´ c∆° b·∫£n ƒë·∫øn n√¢ng cao, gi√∫p b·∫°n n·∫Øm v·ªØng k·ªπ thu·∫≠t ki·ªÉm th·ª≠ x√¢m nh·∫≠p, ph√°t hi·ªán l·ªó h·ªïng b·∫£o m·∫≠t v√† b·∫£o v·ªá h·ªá th·ªëng m·ªôt c√°ch chuy√™n nghi·ªáp.</p>
          <div className="linux-card-tags">
            <span className="linux-card-tag">pentest</span>
            <span className="linux-card-tag">security</span>
            <span className="linux-card-tag">hacking</span>
            <span className="linux-card-tag">ethical</span>
          </div>
          <div className="linux-card-info">
            <span className="linux-card-author">T√°c gi·∫£ <b>CyberCity Team</b></span>
            <span className="linux-card-students"><svg width="18" height="18" style={{ verticalAlign: 'middle' }}><circle cx="9" cy="9" r="8" fill="#ff0000"/></svg> 8,567 H·ªçc vi√™n</span>
            <span className="linux-card-rating">
              <span className="star">‚òÖ</span><span className="star">‚òÖ</span><span className="star">‚òÖ</span><span className="star">‚òÖ</span><span className="star">‚òÖ</span>
              <span className="linux-card-rating-value">4.8</span>
            </span>
          </div>
        </div>
        <div className="linux-card-right">
          <img src="https://cdn-icons-png.flaticon.com/512/6195/6195699.png" alt="Penetration Testing" className="linux-card-img" />
        </div>
        <div className="linux-card-progress-bar">
          <div className="linux-card-progress" style={{ width: `${headerProgress}%` }}></div>
          <span className="linux-card-progress-label"></span>
        </div>
      </div>

      <div className="container">
        <div className="section">
          <h2>üöÄ Gi·ªõi Thi·ªáu</h2>
          <div className="intro-grid">
            <div className="intro-item">
              <h3>üîê Gi·ªõi Thi·ªáu S∆° Qua</h3>
              <p>Penetration Testing (Pentest) l√† qu√° tr√¨nh ki·ªÉm tra b·∫£o m·∫≠t h·ªá th·ªëng b·∫±ng c√°ch m√¥ ph·ªèng c√°c cu·ªôc t·∫•n c√¥ng th·ª±c t·∫ø. ƒê√¢y l√† k·ªπ nƒÉng quan tr·ªçng trong lƒ©nh v·ª±c an ninh m·∫°ng, gi√∫p ph√°t hi·ªán v√† kh·∫Øc ph·ª•c c√°c l·ªó h·ªïng b·∫£o m·∫≠t tr∆∞·ªõc khi tin t·∫∑c th·ª±c s·ª± khai th√°c ch√∫ng.</p>
            </div>
            <div className="intro-item">
              <h3>‚ö° ƒê·∫∑c Tr∆∞ng C∆° B·∫£n Pentest</h3>
              <p>‚Ä¢ Ki·ªÉm tra to√†n di·ªán h·ªá th·ªëng<br/>‚Ä¢ Ph√°t hi·ªán l·ªó h·ªïng b·∫£o m·∫≠t<br/>‚Ä¢ ƒê√°nh gi√° m·ª©c ƒë·ªô r·ªßi ro<br/>‚Ä¢ Tu√¢n th·ªß ƒë·∫°o ƒë·ª©c v√† ph√°p l√Ω<br/>‚Ä¢ B√°o c√°o chi ti·∫øt v√† khuy·∫øn ngh·ªã<br/>‚Ä¢ C·∫£i thi·ªán t∆∞ th·∫ø b·∫£o m·∫≠t t·ªïng th·ªÉ</p>
            </div>
            <div className="intro-item">
              <h3>üåü ·ª®ng D·ª•ng C·ªßa Pentest</h3>
              <p>‚Ä¢ Ki·ªÉm tra b·∫£o m·∫≠t web application<br/>‚Ä¢ ƒê√°nh gi√° an ninh m·∫°ng doanh nghi·ªáp<br/>‚Ä¢ Ki·ªÉm th·ª≠ mobile application<br/>‚Ä¢ ƒê√°nh gi√° b·∫£o m·∫≠t API<br/>‚Ä¢ Red Team Assessment<br/>‚Ä¢ Compliance v√† Audit</p>
            </div>
            <div className="intro-item">
              <h3>üéØ M·ª•c Ti√™u Kh√≥a H·ªçc</h3>
              <p>Kh√≥a h·ªçc gi√∫p b·∫°n n·∫Øm v·ªØng ki·∫øn th·ª©c v√† k·ªπ nƒÉng Penetration Testing t·ª´ c∆° b·∫£n ƒë·∫øn n√¢ng cao, c√≥ kh·∫£ nƒÉng th·ª±c hi·ªán c√°c cu·ªôc ki·ªÉm th·ª≠ b·∫£o m·∫≠t chuy√™n nghi·ªáp, ph√°t hi·ªán l·ªó h·ªïng v√† ƒë∆∞a ra c√°c khuy·∫øn ngh·ªã kh·∫Øc ph·ª•c hi·ªáu qu·∫£.</p>
            </div>
          </div>
          <div className="intro-item">
            <h3>üí° L·ªùi K·∫øt</h3>
            <p>H√†nh tr√¨nh h·ªçc Penetration Testing kh√¥ng ch·ªâ l√† vi·ªác n·∫Øm b·∫Øt c√°c k·ªπ thu·∫≠t t·∫•n c√¥ng m√† c√≤n l√† tr√°ch nhi·ªám b·∫£o v·ªá h·ªá th·ªëng v√† d·ªØ li·ªáu. H√£y c√πng ch√∫ng t√¥i tr·ªü th√†nh m·ªôt Ethical Hacker chuy√™n nghi·ªáp v√† ƒë√≥ng g√≥p v√†o vi·ªác l√†m cho th·∫ø gi·ªõi s·ªë an to√†n h∆°n!</p>
          </div>
        </div>

        <div className="section">
          <h2>üìö N·ªôi Dung Kh√≥a H·ªçc</h2>
          <div className="course-content">
            {modules.map((m, idx) => (
              <div className="module" key={m.title}>
                <h3>{m.title}</h3>
                <div className="module-content">
                  <div className="topics">
                    <h4>üìã N·ªôi dung:</h4>
                    <ul>
                      {m.topics.map(topic => (
                        <li key={topic}>{topic}</li>
                      ))}
                    </ul>
                    <div className="progress-bar">
                      <div className="progress" style={{ width: `${introProgress[idx]}%` }}></div>
                    </div>
                  </div>
                  <div className="rating-comment">
                    <div className="rating">
                      <h4>‚≠ê ƒê√°nh gi√°:</h4>
                      <div className="stars">
                        {Array.from({ length: 5 }).map((_, i) => (
                          <span className="star" key={i}>{i < m.rating ? '‚òÖ' : '‚òÜ'}</span>
                        ))}
                      </div>
                    </div>
                    <h4>üí¨ B√¨nh lu·∫≠n:</h4>
                    <textarea className="comment-box" placeholder={m.commentPlaceholder}></textarea>
                    <a className="btn" href={idx === 0 ? '/pentest/module-1' : '#'}>{idx === 0 ? 'V√†o Module 1' : 'G·ª≠i b√¨nh lu·∫≠n'}</a>
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>

        <div className="footer">
          <h3>üéì Ho√†n Th√†nh Kh√≥a H·ªçc</h3>
          <p>Ch√∫c m·ª´ng b·∫°n ƒë√£ ho√†n th√†nh h√†nh tr√¨nh h·ªçc Penetration Testing! H√£y ti·∫øp t·ª•c th·ª±c h√†nh v√† kh√°m ph√° th√™m nhi·ªÅu k·ªπ thu·∫≠t b·∫£o m·∫≠t kh√°c.</p>
          <button className="btn" style={{ marginTop: 20 }}>Nh·∫≠n Ch·ª©ng Ch·ªâ</button>
        </div>
      </div>
    </div>
  );
};

export default PenTestPage;

