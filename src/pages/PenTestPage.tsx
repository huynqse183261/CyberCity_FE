import React, { useEffect, useState } from 'react';
import { useNavigate } from 'react-router-dom';
import LinuxLabNavigation from '../components/LinuxLabNavigation';
import UserDropdown from '../components/UserDropdown';
import { useAuth } from '../contexts/AuthContext';
import type { User } from '../models/LinuxLabTypes';
import '../styles/LinuxLabPage.css';
import contentService, { type CourseSummary } from '../services/contentService';

const PenTestPage: React.FC = () => {
  const headerProgress = 15;
  const { user: currentUser } = useAuth();
  const navigate = useNavigate();
  
  // Transform AuthContext user to component user format
  const user: User = {
    name: currentUser?.fullName || 'User',
    username: currentUser?.username || currentUser?.email || 'Unknown User',
    avatar: currentUser?.fullName?.charAt(0).toUpperCase() || 'U'
  };

  const [courses, setCourses] = useState<CourseSummary[]>([]);
  const [loading, setLoading] = useState<boolean>(true);

  useEffect(() => {
    let isMounted = true;
    setLoading(true);
    contentService
      .listCourses({ category: 'pentest' })
      .then((data) => {
        if (isMounted) {
          setCourses(data);
          setLoading(false);
        }
      })
      .catch((err) => {
        if (isMounted) setLoading(false);
      });
    return () => {
      isMounted = false;
    };
  }, []);

  return (
    <div className="linux-lab-page">
      <nav className="navigation">
        <div className="nav-container">
          <LinuxLabNavigation />
          <UserDropdown user={user} />
        </div>
      </nav>

      <div className="linux-card-header">
        <div className="linux-card-left">
          <h1 className="linux-card-title">Kh√≥a H·ªçc Penetration Testing</h1>
          <p className="linux-card-desc">Kh√≥a h·ªçc th·ª±c h√†nh Penetration Testing t·ª´ c∆° b·∫£n ƒë·∫øn n√¢ng cao, gi√∫p b·∫°n n·∫Øm v·ªØng k·ªπ thu·∫≠t ki·ªÉm th·ª≠ x√¢m nh·∫≠p, ph√°t hi·ªán l·ªó h·ªïng b·∫£o m·∫≠t v√† b·∫£o v·ªá h·ªá th·ªëng m·ªôt c√°ch chuy√™n nghi·ªáp.</p>
          <div className="linux-card-tags">
            <span className="linux-card-tag">Ki·ªÉm th·ª≠ x√¢m nh·∫≠p</span>
            <span className="linux-card-tag">B·∫£o m·∫≠t</span>
            <span className="linux-card-tag">T·∫•n c√¥ng</span>
            <span className="linux-card-tag">ƒê·∫°o ƒë·ª©c</span>
          </div>
          <div className="linux-card-info">
            <span className="linux-card-author">T√°c gi·∫£ <b>CyberCity Team</b></span>
            <span className="linux-card-students"><svg width="18" height="18" style={{ verticalAlign: 'middle' }}><circle cx="9" cy="9" r="8" fill="#ff0000"/></svg> 8,567 H·ªçc vi√™n</span>
            <span className="linux-card-rating">
              <span className="star">‚òÖ</span><span className="star">‚òÖ</span><span className="star">‚òÖ</span><span className="star">‚òÖ</span><span className="star">‚òÖ</span>
              <span className="linux-card-rating-value">4.8</span>
            </span>
          </div>
        </div>
        <div className="linux-card-right">
          <img src="https://cdn-icons-png.flaticon.com/512/6195/6195699.png" alt="Penetration Testing" className="linux-card-img" />
        </div>
        <div className="linux-card-progress-bar">
          <div className="linux-card-progress" style={{ width: `${headerProgress}%` }}></div>
          <span className="linux-card-progress-label"></span>
        </div>
      </div>

      <div className="container">
        <div className="section">
          <h2>üöÄ Gi·ªõi Thi·ªáu</h2>
          <div className="intro-grid">
            <div className="intro-item">
              <h3>üîê Gi·ªõi Thi·ªáu S∆° Qua</h3>
              <p>Penetration Testing (Pentest) l√† qu√° tr√¨nh ki·ªÉm tra b·∫£o m·∫≠t h·ªá th·ªëng b·∫±ng c√°ch m√¥ ph·ªèng c√°c cu·ªôc t·∫•n c√¥ng th·ª±c t·∫ø. ƒê√¢y l√† k·ªπ nƒÉng quan tr·ªçng trong lƒ©nh v·ª±c an ninh m·∫°ng, gi√∫p ph√°t hi·ªán v√† kh·∫Øc ph·ª•c c√°c l·ªó h·ªïng b·∫£o m·∫≠t tr∆∞·ªõc khi tin t·∫∑c th·ª±c s·ª± khai th√°c ch√∫ng.</p>
            </div>
            <div className="intro-item">
              <h3>‚ö° ƒê·∫∑c Tr∆∞ng C∆° B·∫£n Pentest</h3>
              <p>‚Ä¢ Ki·ªÉm tra to√†n di·ªán h·ªá th·ªëng<br/>‚Ä¢ Ph√°t hi·ªán l·ªó h·ªïng b·∫£o m·∫≠t<br/>‚Ä¢ ƒê√°nh gi√° m·ª©c ƒë·ªô r·ªßi ro<br/>‚Ä¢ Tu√¢n th·ªß ƒë·∫°o ƒë·ª©c v√† ph√°p l√Ω<br/>‚Ä¢ B√°o c√°o chi ti·∫øt v√† khuy·∫øn ngh·ªã<br/>‚Ä¢ C·∫£i thi·ªán t∆∞ th·∫ø b·∫£o m·∫≠t t·ªïng th·ªÉ</p>
            </div>
            <div className="intro-item">
              <h3>üåü ·ª®ng D·ª•ng C·ªßa Pentest</h3>
              <p>‚Ä¢ Ki·ªÉm tra b·∫£o m·∫≠t web application<br/>‚Ä¢ ƒê√°nh gi√° an ninh m·∫°ng doanh nghi·ªáp<br/>‚Ä¢ Ki·ªÉm th·ª≠ mobile application<br/>‚Ä¢ ƒê√°nh gi√° b·∫£o m·∫≠t API<br/>‚Ä¢ Red Team Assessment<br/>‚Ä¢ Compliance v√† Audit</p>
            </div>
            <div className="intro-item">
              <h3>üéØ M·ª•c Ti√™u Kh√≥a H·ªçc</h3>
              <p>Kh√≥a h·ªçc gi√∫p b·∫°n n·∫Øm v·ªØng ki·∫øn th·ª©c v√† k·ªπ nƒÉng Penetration Testing t·ª´ c∆° b·∫£n ƒë·∫øn n√¢ng cao, c√≥ kh·∫£ nƒÉng th·ª±c hi·ªán c√°c cu·ªôc ki·ªÉm th·ª≠ b·∫£o m·∫≠t chuy√™n nghi·ªáp, ph√°t hi·ªán l·ªó h·ªïng v√† ƒë∆∞a ra c√°c khuy·∫øn ngh·ªã kh·∫Øc ph·ª•c hi·ªáu qu·∫£.</p>
            </div>
          </div>
          <div className="intro-item">
            <h3>üí° L·ªùi K·∫øt</h3>
            <p>H√†nh tr√¨nh h·ªçc Penetration Testing kh√¥ng ch·ªâ l√† vi·ªác n·∫Øm b·∫Øt c√°c k·ªπ thu·∫≠t t·∫•n c√¥ng m√† c√≤n l√† tr√°ch nhi·ªám b·∫£o v·ªá h·ªá th·ªëng v√† d·ªØ li·ªáu. H√£y c√πng ch√∫ng t√¥i tr·ªü th√†nh m·ªôt Ethical Hacker chuy√™n nghi·ªáp v√† ƒë√≥ng g√≥p v√†o vi·ªác l√†m cho th·∫ø gi·ªõi s·ªë an to√†n h∆°n!</p>
          </div>
        </div>

        <div className="section">
          <h2>üìö Danh S√°ch B√†i H·ªçc</h2>
          {loading ? (
            <div style={{ textAlign: 'center', padding: '40px' }}>
              <p>ƒêang t·∫£i danh s√°ch b√†i h·ªçc...</p>
            </div>
          ) : courses.length === 0 ? (
            <div style={{ textAlign: 'center', padding: '40px' }}>
              <p>Ch∆∞a c√≥ b√†i h·ªçc n√†o.</p>
            </div>
          ) : (
            <div className="course-content">
              {courses.map((course: CourseSummary) => (
                <div className="module" key={course.uid}>
                  <h3>{course.title}</h3>
                  <div className="module-content">
                    <div className="topics">
                      <h4>üìã M√¥ t·∫£:</h4>
                      <p className="topics-description">
                        {course.description}
                      </p>
                      <div className="progress-bar">
                        <div className="progress" style={{ width: '0%' }}></div>
                      </div>
                    </div>
                    <div className="rating-comment">
                      <div style={{ display: 'flex', gap: 10, marginTop: 10 }}>
                        <button 
                          className="btn" 
                          onClick={() => {
                            // M·ªói course l√† m·ªôt b√†i h·ªçc ri√™ng
                            // Navigate to course detail page v·ªõi courseUid
                            navigate(`/pentest/course/${course.uid}`);
                          }}
                        >
                          V√†o b√†i h·ªçc ‚Üí
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

export default PenTestPage;

