import axiosInstance from '../api/axiosInstance';
import type {
  Course,
  CourseWithProgress,
  Module,
  Lesson,
  LearningContent,
  Subtopic,
  SubmitAnswerRequest,
  SubmitAnswerResponse,
  Quiz,
  QuizQuestion,
  QuizAnswer,
  QuizSubmission,
  SubmitQuizRequest,
  SubmitQuizResponse,
  Lab,
  LabWithComponents,
  StudentProgress,
  CourseProgress,
  SubtopicProgress,
  CourseEnrollment,
  ApiResponse
} from '../models/PenTestLearningTypes';

class PenTestLearningService {
  
  // ============ COURSE METHODS ============
  
  async getAllCourses(): Promise<CourseWithProgress[]> {
    const response = await axiosInstance.get<ApiResponse<CourseWithProgress[]>>('/api/learning/courses');
    return response.data.data;
  }

  async getCourseById(courseId: string) {
    const response = await axiosInstance.get<ApiResponse<{
      course: Course;
      modules: Module[];
      enrollment: CourseEnrollment | null;
      progress: {
        totalLessons: number;
        completedLessons: number;
        percentage: number;
      };
    }>>(`/api/learning/courses/${courseId}`);
    return response.data.data;
  }

  async enrollCourse(courseId: string): Promise<CourseEnrollment> {
    const response = await axiosInstance.post<ApiResponse<CourseEnrollment>>(`/api/learning/courses/${courseId}/enroll`, {});
    return response.data.data;
  }

  // ============ MODULE METHODS ============
  
  async getModulesByCourse(courseId: string): Promise<Module[]> {
    const response = await axiosInstance.get<ApiResponse<Module[]>>(`/api/learning/courses/${courseId}/modules`);
    return response.data.data;
  }

  async getModuleById(moduleId: string) {
    const response = await axiosInstance.get<ApiResponse<{
      module: Module;
      lessons: Lesson[];
      labs: Lab[];
      progress: {
        totalItems: number;
        completedItems: number;
        percentage: number;
      };
    }>>(`/api/learning/modules/${moduleId}`);
    return response.data.data;
  }

  // ============ LESSON METHODS ============
  
  async getLessonById(lessonId: string) {
    const response = await axiosInstance.get<ApiResponse<{
      lesson: Lesson;
      topics: Array<{
        topic: any;
        subtopics: Subtopic[];
        answers: any[];
      }>;
      quiz: Quiz | null;
    }>>(`/api/learning/lessons/${lessonId}`);
    return response.data.data;
  }

  async getLessonContent(lessonId: string): Promise<LearningContent> {
    const response = await axiosInstance.get<ApiResponse<LearningContent>>(`/api/learning/lessons/${lessonId}/content`);
    return response.data.data;
  }

  // ============ SUBTOPIC METHODS ============
  
  async submitSubtopicAnswer(
    subtopicId: string,
    data: SubmitAnswerRequest
  ): Promise<SubmitAnswerResponse> {
    const response = await axiosInstance.post<ApiResponse<SubmitAnswerResponse>>(
      `/api/learning/subtopics/${subtopicId}/submit-answer`,
      data
    );
    return response.data.data;
  }

  async completeSubtopic(subtopicId: string): Promise<SubtopicProgress> {
    const response = await axiosInstance.post<ApiResponse<SubtopicProgress>>(
      `/api/learning/subtopics/${subtopicId}/complete`,
      {}
    );
    return response.data.data;
  }

  // ============ QUIZ METHODS ============
  
  async getQuizById(quizId: string) {
    const response = await axiosInstance.get<ApiResponse<{
      quiz: Quiz;
      questions: Array<{
        question: QuizQuestion;
        answers: QuizAnswer[];
      }>;
      userSubmission: QuizSubmission | null;
    }>>(`/api/learning/quizzes/${quizId}`);
    return response.data.data;
  }

  async submitQuiz(
    quizId: string,
    data: SubmitQuizRequest
  ): Promise<SubmitQuizResponse> {
    const response = await axiosInstance.post<ApiResponse<SubmitQuizResponse>>(`/api/learning/quizzes/${quizId}/submit`, data);
    return response.data.data;
  }

  // ============ LAB METHODS ============
  
  async getLabsByModule(moduleId: string): Promise<Lab[]> {
    const response = await axiosInstance.get<ApiResponse<Lab[]>>(`/api/learning/modules/${moduleId}/labs`);
    return response.data.data;
  }

  async getLabById(labId: string): Promise<LabWithComponents> {
    const response = await axiosInstance.get<ApiResponse<LabWithComponents>>(`/api/learning/labs/${labId}`);
    return response.data.data;
  }

  async startLab(labId: string) {
    const response = await axiosInstance.post<ApiResponse<{
      sessionId: string;
      components: Array<{
        componentId: string;
        status: 'starting' | 'running' | 'stopped';
        accessUrl: string;
      }>;
    }>>(`/api/learning/labs/${labId}/start`, {});
    return response.data.data;
  }

  async completeLab(labId: string) {
    const response = await axiosInstance.post<ApiResponse<any>>(`/api/learning/labs/${labId}/complete`, {});
    return response.data.data;
  }

  // ============ PROGRESS METHODS ============
  
  async getStudentProgress(): Promise<StudentProgress> {
    const response = await axiosInstance.get<ApiResponse<StudentProgress>>('/api/learning/students/progress');
    return response.data.data;
  }

  async getCourseProgress(courseId: string): Promise<CourseProgress> {
    const response = await axiosInstance.get<ApiResponse<CourseProgress>>(`/api/learning/students/progress/course/${courseId}`);
    return response.data.data;
  }
}

export const penTestLearningService = new PenTestLearningService();
export default penTestLearningService;
